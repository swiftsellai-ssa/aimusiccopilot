<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EM3T93JVNY"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-EM3T93JVNY');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Co-pilot - Enhanced Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .app-container {
            display: grid;
            grid-template-areas: 
                "header header header"
                "sidebar terminal controls"
                "sidebar terminal controls";
            grid-template-columns: 250px 1fr 350px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-areas: 
                    "header"
                    "terminal"
                    "controls"
                    "sidebar";
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr auto auto;
                height: auto;
            }
        }

        /* Header */
        .header {
            grid-area: header;
            background: rgba(0,0,0,0.9);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 1.2rem;
            font-weight: bold;
            color: #50fa7b;
            text-decoration: none;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background: rgba(0,0,0,0.8);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #ff79c6;
            margin-bottom: 15px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .preset-list {
            margin-bottom: 30px;
        }

        .preset-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .preset-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .preset-item.active {
            background: rgba(80,250,123,0.2);
            border-color: #50fa7b;
        }

        /* Terminal */
        .terminal-container {
            grid-area: terminal;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .terminal {
            flex: 1;
            background: rgba(0,0,0,0.9);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .terminal-buttons {
            display: flex;
            gap: 8px;
            margin-right: 15px;
        }

        .terminal-button {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .close { background: #ff5f57; }
        .minimize { background: #ffbd2e; }
        .maximize { background: #28ca42; }

        .terminal-title {
            color: #8be9fd;
            font-weight: bold;
            flex: 1;
        }

        .terminal-stats {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .output {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.4;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            min-height: 300px;
        }

        .output::-webkit-scrollbar {
            width: 8px;
        }

        .output::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .output::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }

        .input-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .prompt {
            color: #50fa7b;
            font-weight: bold;
            white-space: nowrap;
        }

        .command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
            padding: 10px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            transition: border-color 0.3s;
        }

        .command-input:focus {
            border-color: #50fa7b;
        }

        .send-btn {
            background: linear-gradient(45deg, #50fa7b, #8be9fd);
            border: none;
            color: #000;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(80,250,123,0.4);
        }

        /* Controls Panel */
        .controls-panel {
            grid-area: controls;
            background: rgba(0,0,0,0.8);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #ff79c6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-btn {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .control-btn.danger {
            border-color: #ff5555;
            color: #ff5555;
        }

        .control-btn.danger:hover {
            background: rgba(255,85,85,0.2);
        }

        .control-btn.success {
            border-color: #50fa7b;
            color: #50fa7b;
        }

        .control-btn.success:hover {
            background: rgba(80,250,123,0.2);
        }

        .state-display {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .player-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .playing { background: #50fa7b; }
        .stopped { background: #ff5555; }

        /* Mixer Section */
        .mixer {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .mixer-channel {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }

        .channel-name {
            width: 30px;
            font-size: 0.8rem;
            color: #8be9fd;
        }

        .channel-slider {
            flex: 1;
            margin: 0 10px;
        }

        .channel-value {
            width: 35px;
            font-size: 0.8rem;
            text-align: right;
        }

        .mute-btn {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.3);
            background: transparent;
            color: #fff;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 5px;
        }

        .mute-btn.active {
            background: #ff5555;
        }

        /* Recording Section */
        .recording-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .record-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .record-btn.record {
            background: linear-gradient(45deg, #ff5555, #ff7979);
            color: white;
        }

        .record-btn.stop {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
        }

        .record-btn.export {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
        }

        .record-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .record-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            color: #ff5555;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .recording-indicator.active {
            display: flex;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: #ff5555;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Effects Panel */
        .effects-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .effect-btn {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .effect-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .effect-btn.active {
            background: rgba(80,250,123,0.3);
            border-color: #50fa7b;
        }

        /* API Setup */
        .api-key-setup {
            background: rgba(255,184,108,0.1);
            border: 1px solid #ffb86c;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .api-input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            padding: 8px;
            color: #fff;
            font-family: 'Courier New', monospace;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        /* Message styles */
        .error { color: #ff5555; }
        .success { color: #50fa7b; }
        .info { color: #8be9fd; }
        .warning { color: #ffb86c; }
        .ai { color: #bd93f9; }

        /* Floating visualization */
        .visualizer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .viz-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to top, #50fa7b, #8be9fd, #bd93f9);
            opacity: 0.3;
            transition: height 0.1s ease;
        }
    </style>
</head>
<body>
    <!-- Audio Visualizer -->
    <div class="visualizer" id="visualizer"></div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <a href="index.html" class="logo">üéµ AI Music Co-pilot</a>
            <div class="header-controls">
                <button class="header-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
                <button class="header-btn" onclick="shareProject()">üîó Share</button>
                <button class="header-btn" onclick="showSettings()">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="api-key-setup" id="apiSetup">
                <h3>üîë API Setup</h3>
                <input type="text" class="api-input" id="apiKeyInput" placeholder="Google AI API Key">
                <button class="control-btn success" onclick="setupAPI()">Save Key</button>
            </div>

            <div class="preset-list">
                <h3>üéº Quick Presets</h3>
                <div class="preset-item" onclick="loadPreset('techno')">
                    <strong>Techno Starter</strong><br>
                    <small>Four-on-the-floor with bass</small>
                </div>
                <div class="preset-item" onclick="loadPreset('ambient')">
                    <strong>Ambient Pad</strong><br>
                    <small>Atmospheric soundscape</small>
                </div>
                <div class="preset-item" onclick="loadPreset('house')">
                    <strong>House Beat</strong><br>
                    <small>Classic house rhythm</small>
                </div>
                <div class="preset-item" onclick="loadPreset('dnb')">
                    <strong>Drum & Bass</strong><br>
                    <small>Fast breakbeat pattern</small>
                </div>
                <div class="preset-item" onclick="loadPreset('minimal')">
                    <strong>Minimal Tech</strong><br>
                    <small>Stripped-down groove</small>
                </div>
            </div>

            <div class="preset-list">
                <h3>üìÅ Recent Projects</h3>
                <div class="preset-item">
                    <strong>My Track #1</strong><br>
                    <small>2 min ago</small>
                </div>
                <div class="preset-item">
                    <strong>Ambient Experiment</strong><br>
                    <small>1 hour ago</small>
                </div>
            </div>
        </aside>

        <!-- Terminal -->
        <main class="terminal-container">
            <div class="terminal">
                <div class="terminal-header">
                    <div class="terminal-buttons">
                        <div class="terminal-button close"></div>
                        <div class="terminal-button minimize"></div>
                        <div class="terminal-button maximize"></div>
                    </div>
                    <div class="terminal-title">AI Music Terminal v2.0</div>
                    <div class="terminal-stats">
                        <span>üéµ BPM: <span id="bpmDisplay">120</span></span>
                        <span>‚è±Ô∏è <span id="timeDisplay">00:00</span></span>
                        <span>üîä <span id="activeCount">0</span> active</span>
                    </div>
                </div>
                
                <div class="output" id="output">
                    <div class="success">üéµ Welcome to AI Music Co-pilot Enhanced Studio!</div>
                    <div class="info">‚ú® New features: Audio recording, effects, presets, and more!</div>
                    <div class="ai">ü§ñ AI: Ready to create amazing music with you!</div>
                    <div class="info">üí° Try: "create a driving techno beat with acid bass"</div>
                    <div class="info">üéπ Direct: "play melody [0,2,4,5] with reverb"</div>
                    <div class="info">‚ö° Type "help" for full command list</div>
                </div>
                
                <div class="input-section">
                    <div class="prompt">üéß ></div>
                    <input type="text" class="command-input" id="commandInput" placeholder="Describe your musical vision..." autofocus>
                    <button class="send-btn" onclick="processCommand()">Send</button>
                </div>
            </div>
        </main>

        <!-- Controls Panel -->
        <aside class="controls-panel">
            <!-- Recording Section -->
            <div class="control-section">
                <h3>üéôÔ∏è Recording Studio</h3>
                <div class="recording-indicator" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    Recording...
                </div>
                <div class="recording-controls">
                    <button class="record-btn record" onclick="startRecording()">‚è∫Ô∏è</button>
                    <button class="record-btn stop" onclick="stopRecording()" disabled>‚èπÔ∏è</button>
                    <button class="record-btn export" onclick="exportAudio()" disabled>üíæ</button>
                </div>
            </div>

            <!-- Master Controls -->
            <div class="control-section">
                <h3>üéöÔ∏è Master Mix</h3>
                <div class="mixer">
                    <div class="mixer-channel">
                        <div class="channel-name">VOL</div>
                        <input type="range" class="channel-slider" id="masterVolume" min="0" max="1" step="0.05" value="0.7" onchange="setMasterVolume(this.value)">
                        <div class="channel-value" id="volumeDisplay">70%</div>
                    </div>
                    <div class="mixer-channel">
                        <div class="channel-name">BPM</div>
                        <input type="range" class="channel-slider" id="masterTempo" min="60" max="180" value="120" onchange="setTempo(this.value)">
                        <div class="channel-value" id="tempoDisplay">120</div>
                    </div>
                </div>
            </div>

            <!-- Effects -->
            <div class="control-section">
                <h3>üéõÔ∏è Global Effects</h3>
                <div class="effects-grid">
                    <button class="effect-btn" onclick="toggleEffect('reverb')">Reverb</button>
                    <button class="effect-btn" onclick="toggleEffect('delay')">Delay</button>
                    <button class="effect-btn" onclick="toggleEffect('distortion')">Drive</button>
                    <button class="effect-btn" onclick="toggleEffect('filter')">Filter</button>
                </div>
            </div>

            <!-- Transport Controls -->
            <div class="control-section">
                <h3>‚èØÔ∏è Transport</h3>
                <button class="control-btn success" onclick="playAll()">‚ñ∂Ô∏è Play All</button>
                <button class="control-btn" onclick="pauseAll()">‚è∏Ô∏è Pause All</button>
                <button class="control-btn danger" onclick="stopAllSounds()">‚èπÔ∏è Stop All</button>
                <button class="control-btn" onclick="clearTerminal()">üßπ Clear Log</button>
            </div>

            <!-- Active Players -->
            <div class="control-section">
                <h3>üéµ Live Players</h3>
                <div class="state-display" id="playersState">
                    <div class="info">No active players</div>
                </div>
            </div>

            <!-- Player Mixer -->
            <div class="control-section">
                <h3>üéõÔ∏è Player Mixer</h3>
                <div class="mixer" id="playerMixer">
                    <div class="info" style="text-align: center; opacity: 0.6;">
                        Players will appear here
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // Enhanced audio system with recording
        let audioContext;
        let masterGain;
        let reverbNode;
        let delayNode;
        let filterNode;
        let distortionNode;
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let currentTempo = 120;
        let musicState = {};
        let apiKey = '';
        let startTime = Date.now();
        let globalEffects = {};

        // Initialize enhanced audio system
        async function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create master chain
                masterGain = audioContext.createGain();
                reverbNode = createReverb();
                delayNode = createDelay();
                filterNode = audioContext.createBiquadFilter();
                distortionNode = createDistortion();
                
                // Connect effects chain
                masterGain.connect(reverbNode);
                reverbNode.connect(delayNode);
                delayNode.connect(filterNode);
                filterNode.connect(distortionNode);
                distortionNode.connect(audioContext.destination);
                
                masterGain.gain.value = 0.7;
                filterNode.type = 'lowpass';
                filterNode.frequency.value = 20000;
                
                // Initialize visualizer
                initVisualizer();
            }
            return audioContext.state === 'suspended' ? audioContext.resume() : Promise.resolve();
        }

        // Create reverb effect
        function createReverb() {
            const convolver = audioContext.createConvolver();
            const impulseBuffer = audioContext.createBuffer(2, audioContext.sampleRate * 2, audioContext.sampleRate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulseBuffer.getChannelData(channel);
                for (let i = 0; i < channelData.length; i++) {
                    channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / channelData.length, 2);
                }
            }
            
            convolver.buffer = impulseBuffer;
            return convolver;
        }

        // Create delay effect
        function createDelay() {
            const delay = audioContext.createDelay(1.0);
            const feedback = audioContext.createGain();
            const delayGain = audioContext.createGain();
            
            delay.delayTime.value = 0.3;
            feedback.gain.value = 0.3;
            delayGain.gain.value = 0.2;
            
            delay.connect(feedback);
            feedback.connect(delay);
            delay.connect(delayGain);
            
            return delayGain;
        }

        // Create distortion effect
        function createDistortion() {
            const waveshaper = audioContext.createWaveShaper();
            const samples = 44100;
            const curve = new Float32Array(samples);
            const deg = Math.PI / 180;
            
            for (let i = 0; i < samples; i++) {
                const x = (i * 2) / samples - 1;
                curve[i] = ((3 + 30) * x * 20 * deg) / (Math.PI + 30 * Math.abs(x));
            }
            
            waveshaper.curve = curve;
            waveshaper.oversample = '4x';
            return waveshaper;
        }

        // Enhanced synthesizer with effects
        function createEnhancedOscillator(frequency, type = 'sine', duration = 1, effects = {}) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();
            
            osc.type = type;
            osc.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            // Apply effects
            if (effects.lpf) {
                filter.type = 'lowpass';
                filter.frequency.value = effects.lpf;
                filter.Q.value = effects.resonance || 1;
            }
            
            gain.gain.setValueAtTime(effects.amp || 0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            // Connect audio chain
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);
            
            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + duration);
            
            return osc;
        }

        // Enhanced drum sounds
        function playEnhancedDrum(type, duration = 0.2, effects = {}) {
            if (type === 'kick' || type === 'x') {
                const osc1 = audioContext.createOscillator();
                const osc2 = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(60, audioContext.currentTime);
                osc1.frequency.exponentialRampToValueAtTime(30, audioContext.currentTime + 0.1);
                
                osc2.type = 'triangle';
                osc2.frequency.setValueAtTime(120, audioContext.currentTime);
                osc2.frequency.exponentialRampToValueAtTime(60, audioContext.currentTime + 0.05);
                
                filter.type = 'lowpass';
                filter.frequency.value = 200;
                
                gain.gain.setValueAtTime(effects.amp || 0.8, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                osc1.connect(filter);
                osc2.connect(filter);
                filter.connect(gain);
                gain.connect(masterGain);
                
                osc1.start(audioContext.currentTime);
                osc2.start(audioContext.currentTime);
                osc1.stop(audioContext.currentTime + duration);
                osc2.stop(audioContext.currentTime + 0.1);
                
            } else if (type === 'snare' || type === 'o') {
                // Enhanced snare with tone
                const noise = createNoiseBuffer(duration);
                const tone = audioContext.createOscillator();
                const noiseGain = audioContext.createGain();
                const toneGain = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                tone.type = 'triangle';
                tone.frequency.value = 200;
                
                filter.type = 'bandpass';
                filter.frequency.value = 1000;
                filter.Q.value = 1;
                
                noiseGain.gain.setValueAtTime(0.3, audioContext.currentTime);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                toneGain.gain.setValueAtTime(0.2, audioContext.currentTime);
                toneGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration * 0.3);
                
                noise.connect(filter);
                filter.connect(noiseGain);
                tone.connect(toneGain);
                noiseGain.connect(masterGain);
                toneGain.connect(masterGain);
                
                noise.start(audioContext.currentTime);
                tone.start(audioContext.currentTime);
                noise.stop(audioContext.currentTime + duration);
                tone.stop(audioContext.currentTime + duration * 0.3);
                
            } else if (type === 'h' || type === '.') {
                // Hi-hat
                const noise = createNoiseBuffer(duration * 0.3);
                const gain = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                filter.type = 'highpass';
                filter.frequency.value = 8000;
                
                gain.gain.setValueAtTime(0.15, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration * 0.3);
                
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(masterGain);
                
                noise.start(audioContext.currentTime);
                noise.stop(audioContext.currentTime + duration * 0.3);
            }
        }

        function createNoiseBuffer(duration) {
            const bufferSize = audioContext.sampleRate * duration;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            
            const whiteNoise = audioContext.createBufferSource();
            whiteNoise.buffer = buffer;
            return whiteNoise;
        }

        // Recording functionality
        async function startRecording() {
            if (!audioContext) {
                await initAudio();
            }
            
            try {
                const dest = audioContext.createMediaStreamDestination();
                masterGain.connect(dest);
                
                mediaRecorder = new MediaRecorder(dest.stream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'audio/wav' });
                    const url = URL.createObjectURL(blob);
                    
                    // Enable export button
                    document.querySelector('.record-btn.export').disabled = false;
                    document.querySelector('.record-btn.export').onclick = () => {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `ai-music-${Date.now()}.wav`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        addOutput('üéµ Audio exported successfully!', 'success');
                    };
                    
                    addOutput('üéôÔ∏è Recording saved! Click export to download.', 'success');
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                document.getElementById('recordingIndicator').classList.add('active');
                document.querySelector('.record-btn.record').disabled = true;
                document.querySelector('.record-btn.stop').disabled = false;
                
                addOutput('üî¥ Recording started...', 'info');
                
            } catch (error) {
                addOutput(`‚ùå Recording error: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Update UI
                document.getElementById('recordingIndicator').classList.remove('active');
                document.querySelector('.record-btn.record').disabled = false;
                document.querySelector('.record-btn.stop').disabled = true;
                
                addOutput('‚èπÔ∏è Recording stopped.', 'info');
            }
        }

        // Visualizer
        function initVisualizer() {
            const visualizer = document.getElementById('visualizer');
            const barCount = 50;
            
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'viz-bar';
                bar.style.left = `${(i / barCount) * 100}%`;
                bar.style.height = '2px';
                visualizer.appendChild(bar);
            }
            
            // Simple animation
            setInterval(() => {
                const bars = visualizer.querySelectorAll('.viz-bar');
                bars.forEach((bar, index) => {
                    const height = Math.random() * 100 + 10;
                    bar.style.height = `${height}px`;
                });
            }, 100);
        }

        // Preset system
        const presets = {
            techno: [
                { command: 'play drums "x---x---x---x---"', delay: 0 },
                { command: 'play bass [0,0,0,7] with drive', delay: 2000 },
                { command: 'add melody [0,3,7,10] with filter sweep', delay: 4000 }
            ],
            ambient: [
                { command: 'play pads [0,4,7,11] with reverb', delay: 0 },
                { command: 'add soft melody [0,2,4,7] slowly', delay: 3000 }
            ],
            house: [
                { command: 'play drums "x-o-x-o-x-o-x-o-"', delay: 0 },
                { command: 'play bass [0,0,3,0] groovy', delay: 1000 },
                { command: 'add piano chords [0,4,7]', delay: 2000 }
            ],
            dnb: [
                { command: 'play drums "x---o--x-o--x---" fast', delay: 0 },
                { command: 'play bass [0,7,3,10] with wobble', delay: 1500 }
            ],
            minimal: [
                { command: 'play drums "x-------x-------"', delay: 0 },
                { command: 'add subtle bass [0,3] minimal', delay: 4000 }
            ]
        };

        function loadPreset(presetName) {
            if (!presets[presetName]) return;
            
            addOutput(`üéº Loading ${presetName} preset...`, 'info');
            
            // Clear existing
            stopAllSounds();
            
            // Load preset with delays
            presets[presetName].forEach((item, index) => {
                setTimeout(() => {
                    executeCommand(item.command);
                }, item.delay);
            });
            
            // Update active preset visual
            document.querySelectorAll('.preset-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.preset-item').classList.add('active');
        }

        // Enhanced AI integration
        async function callGeminiAPI(prompt) {
            if (!apiKey) {
                addOutput('‚ùå Please set up your API key first!', 'error');
                return null;
            }
            
            try {
                addOutput('ü§ñ AI is composing your music...', 'ai');
                
                const enhancedPrompt = `You are an advanced AI music producer for a web-based DAW. 
                
Available commands and syntax:
- "play drums [pattern]" - e.g., "x-o-x-o-" (x=kick, o=snare, -=rest, .=hihat)
- "play bass [notes]" - e.g., [0,0,3,7] with optional effects like "with drive" or "with filter"
- "play melody [notes]" - e.g., [0,2,4,5] with optional "with reverb" or "slowly"
- "play pads [notes]" - for atmospheric sounds
- "add [instrument] [notes]" - adds to existing arrangement
- Effects: "with reverb", "with delay", "with drive", "with filter sweep", "slowly", "fast", "groovy", "minimal"

Current musical context: ${JSON.stringify(musicState)}

User request: "${prompt}"

Respond with a single JSON object containing the most appropriate command:
{"command": "play drums", "pattern": "x-o-x-o-", "player": "d1", "description": "Four-on-the-floor techno beat"}

Focus on creating musically coherent additions that complement existing elements.`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: enhancedPrompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.8,
                            maxOutputTokens: 300
                        }
                    })
                });
                
                const data = await response.json();
                if (data.candidates && data.candidates[0]) {
                    const text = data.candidates[0].content.parts[0].text;
                    try {
                        const jsonMatch = text.match(/\{[^}]*\}/s);
                        if (jsonMatch) {
                            const result = JSON.parse(jsonMatch[0]);
                            if (result.description) {
                                addOutput(`üéµ AI: ${result.description}`, 'ai');
                            }
                            return result;
                        }
                    } catch (e) {
                        addOutput('‚ùå AI returned invalid response', 'error');
                    }
                }
                return null;
            } catch (error) {
                addOutput(`‚ùå AI API error: ${error.message}`, 'error');
                return null;
            }
        }

        // Enhanced command execution
        async function executeCommand(command) {
            await initAudio();
            
            command = command.toLowerCase().trim();
            
            // Handle control commands
            if (command === 'stop all' || command === 'stop') {
                stopAllSounds();
                return;
            }
            
            if (command === 'show state' || command === 'state') {
                showMusicState();
                return;
            }
            
            if (command === 'help') {
                showEnhancedHelp();
                return;
            }
            
            if (command === 'clear' || command === 'cls') {
                clearTerminal();
                return;
            }
            
            // Check if it's a direct command
            if (command.includes('play ') || command.includes('add ')) {
                executeDirectCommand(command);
                return;
            }
            
            // Use AI for natural language
            const aiResponse = await callGeminiAPI(command);
            if (aiResponse) {
                executeAICommand(aiResponse);
            }
        }

        function executeDirectCommand(command) {
            try {
                // Parse drum commands
                if (command.includes('play drums') || command.includes('add drums')) {
                    const patternMatch = command.match(/["']([xoh\.\-]+)["']/) || command.match(/([xoh\.\-]{4,})/);
                    if (patternMatch) {
                        const player = getNextPlayer('d');
                        const pattern = patternMatch[1];
                        const effects = parseEffects(command);
                        
                        startPlayer(player, {
                            type: 'drum',
                            pattern: pattern,
                            effects: effects,
                            status: 'playing'
                        });
                        addOutput(`‚úÖ ${command.includes('add') ? 'Added' : 'Playing'} drums: ${pattern}`, 'success');
                    }
                }
                
                // Parse bass/melody commands
                else if (command.includes('play bass') || command.includes('play melody') || command.includes('play pads') || 
                         command.includes('add bass') || command.includes('add melody') || command.includes('add pads')) {
                    
                    const notesMatch = command.match(/\[([0-9,\s]+)\]/) || command.match(/([0-9,\s]+)/);
                    if (notesMatch) {
                        const notes = notesMatch[1].split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
                        const effects = parseEffects(command);
                        
                        let playerType, octave, waveform;
                        if (command.includes('bass')) {
                            playerType = 'b';
                            octave = 2;
                            waveform = 'sawtooth';
                        } else if (command.includes('pads')) {
                            playerType = 'p';
                            octave = 4;
                            waveform = 'sine';
                            effects.reverb = true;
                        } else {
                            playerType = 'p';
                            octave = 4;
                            waveform = 'sine';
                        }
                        
                        const player = getNextPlayer(playerType);
                        startPlayer(player, {
                            type: 'melody',
                            notes: notes,
                            octave: octave,
                            waveform: waveform,
                            effects: effects,
                            status: 'playing'
                        });
                        
                        const instrumentName = command.includes('bass') ? 'bass' : command.includes('pads') ? 'pads' : 'melody';
                        addOutput(`‚úÖ ${command.includes('add') ? 'Added' : 'Playing'} ${instrumentName}: [${notes.join(',')}]`, 'success');
                    }
                }
                
                updatePlayersDisplay();
            } catch (error) {
                addOutput(`‚ùå Command error: ${error.message}`, 'error');
            }
        }

        function parseEffects(command) {
            const effects = {};
            if (command.includes('reverb')) effects.reverb = true;
            if (command.includes('delay')) effects.delay = true;
            if (command.includes('drive')) effects.drive = 0.4;
            if (command.includes('filter')) effects.lpf = 800;
            if (command.includes('slowly')) effects.duration = 2;
            if (command.includes('fast')) effects.duration = 0.25;
            return effects;
        }

        function getNextPlayer(type) {
            let i = 1;
            while (musicState[`${type}${i}`]) {
                i++;
            }
            return `${type}${i}`;
        }

        function executeAICommand(aiCommand) {
            try {
                if (aiCommand.command && aiCommand.command.includes('drums')) {
                    executeDirectCommand(`play drums "${aiCommand.pattern}"`);
                } else if (aiCommand.command) {
                    executeDirectCommand(aiCommand.command);
                }
            } catch (error) {
                addOutput(`‚ùå AI command error: ${error.message}`, 'error');
            }
        }

        // Enhanced player management
        function startPlayer(player, config) {
            if (musicState[player]) {
                stopPlayer(player);
            }
            
            musicState[player] = config;
            
            if (config.type === 'drum') {
                playEnhancedPattern(player, config.pattern, config, currentTempo);
            } else if (config.type === 'melody') {
                playEnhancedMelody(player, config.notes, config, currentTempo);
            }
            
            updateTimeDisplay();
        }

        function playEnhancedPattern(player, pattern, config, tempo) {
            const beatDuration = 60 / tempo / 4;
            let currentBeat = 0;
            
            function playNextBeat() {
                if (!musicState[player] || musicState[player].status !== 'playing') return;
                
                const char = pattern[currentBeat % pattern.length];
                if (char !== '-' && char !== ' ') {
                    playEnhancedDrum(char, beatDuration * 0.8, config.effects || {});
                }
                
                currentBeat++;
                if (musicState[player] && musicState[player].status === 'playing') {
                    setTimeout(playNextBeat, beatDuration * 1000);
                }
            }
            
            playNextBeat();
        }

        function playEnhancedMelody(player, notes, config, tempo) {
            const noteDuration = (config.effects && config.effects.duration) || (60 / tempo);
            let currentNote = 0;
            
            function playNextNote() {
                if (!musicState[player] || musicState[player].status !== 'playing') return;
                
                const note = notes[currentNote % notes.length];
                const frequency = 440 * Math.pow(2, (note - 9 + (config.octave - 4) * 12) / 12);
                
                createEnhancedOscillator(frequency, config.waveform, noteDuration * 0.8, config.effects || {});
                
                currentNote++;
                if (musicState[player] && musicState[player].status === 'playing') {
                    setTimeout(playNextNote, noteDuration * 1000);
                }
            }
            
            playNextNote();
        }

        // UI Functions
        function processCommand() {
            const input = document.getElementById('commandInput');
            const command = input.value.trim();
            if (!command) return;
            
            addOutput(`üéß > ${command}`, 'info');
            input.value = '';
            
            executeCommand(command);
        }

        function setupAPI() {
            const input = document.getElementById('apiKeyInput');
            apiKey = input.value.trim();
            if (apiKey) {
                document.getElementById('apiSetup').style.display = 'none';
                addOutput('‚úÖ API key configured! AI features are now active.', 'success');
            }
        }

        function addOutput(text, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function setMasterVolume(value) {
            if (masterGain) {
                masterGain.gain.value = value;
            }
            document.getElementById('volumeDisplay').textContent = Math.round(value * 100) + '%';
        }

        function setTempo(value) {
            currentTempo = parseInt(value);
            document.getElementById('tempoDisplay').textContent = value;
            document.getElementById('bpmDisplay').textContent = value;
        }

        function stopPlayer(player) {
            if (musicState[player]) {
                musicState[player].status = 'stopped';
                delete musicState[player];
                updatePlayersDisplay();
            }
        }

        function stopAllSounds() {
            Object.keys(musicState).forEach(stopPlayer);
            addOutput('üõë All sounds stopped', 'success');
            updatePlayersDisplay();
        }

        function playAll() {
            Object.keys(musicState).forEach(player => {
                if (musicState[player].status === 'paused') {
                    musicState[player].status = 'playing';
                    startPlayer(player, musicState[player]);
                }
            });
            addOutput('‚ñ∂Ô∏è Resuming all players', 'success');
        }

        function pauseAll() {
            Object.keys(musicState).forEach(player => {
                if (musicState[player].status === 'playing') {
                    musicState[player].status = 'paused';
                }
            });
            addOutput('‚è∏Ô∏è All players paused', 'info');
            updatePlayersDisplay();
        }

        function clearTerminal() {
            document.getElementById('output').innerHTML = '';
            addOutput('üéµ Terminal cleared', 'info');
        }

        function updatePlayersDisplay() {
            const display = document.getElementById('playersState');
            const mixer = document.getElementById('playerMixer');
            const activePlayers = Object.keys(musicState);
            
            // Update state display
            if (activePlayers.length === 0) {
                display.innerHTML = '<div class="info">No active players</div>';
                mixer.innerHTML = '<div class="info" style="text-align: center; opacity: 0.6;">Players will appear here</div>';
            } else {
                display.innerHTML = activePlayers.map(player => {
                    const config = musicState[player];
                    const status = config.status === 'playing' ? 'playing' : 'stopped';
                    const type = config.type === 'drum' ? 'ü•Å' : config.type === 'melody' ? 'üéπ' : 'üéµ';
                    return `<div><span class="player-indicator ${status}"></span>${type} ${player}: ${config.type}</div>`;
                }).join('');
                
                // Update mixer
                mixer.innerHTML = activePlayers.map(player => {
                    const config = musicState[player];
                    return `
                        <div class="mixer-channel">
                            <div class="channel-name">${player.toUpperCase()}</div>
                            <input type="range" class="channel-slider" min="0" max="1" step="0.05" value="0.7" 
                                   onchange="setPlayerVolume('${player}', this.value)">
                            <div class="channel-value">70%</div>
                            <button class="mute-btn" onclick="toggleMute('${player}')">M</button>
                        </div>
                    `;
                }).join('');
            }
            
            // Update header stats
            document.getElementById('activeCount').textContent = activePlayers.length;
        }

        function setPlayerVolume(player, value) {
            // This would control individual player volumes in a real implementation
            console.log(`Setting ${player} volume to ${value}`);
        }

        function toggleMute(player) {
            if (musicState[player]) {
                const isMuted = musicState[player].muted;
                musicState[player].muted = !isMuted;
                
                if (!isMuted) {
                    stopPlayer(player);
                } else {
                    startPlayer(player, musicState[player]);
                }
                
                updatePlayersDisplay();
            }
        }

        function toggleEffect(effectName) {
            const btn = event.target;
            const isActive = btn.classList.contains('active');
            
            globalEffects[effectName] = !isActive;
            btn.classList.toggle('active');
            
            addOutput(`${isActive ? '‚ùå' : '‚úÖ'} Global ${effectName} ${isActive ? 'disabled' : 'enabled'}`, 'info');
        }

        function updateTimeDisplay() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timeDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function showMusicState() {
            addOutput('üìä CURRENT MUSICAL STATE:', 'info');
            const activePlayers = Object.keys(musicState);
            if (activePlayers.length === 0) {
                addOutput('No active players', 'info');
            } else {
                activePlayers.forEach(player => {
                    const config = musicState[player];
                    addOutput(`${player}: ${config.type} (${config.status})`, 'info');
                });
            }
        }

        function showEnhancedHelp() {
            addOutput('üéµ AI MUSIC CO-PILOT ENHANCED HELP', 'info');
            addOutput('', 'info');
            addOutput('üí° NATURAL LANGUAGE (AI-powered):', 'ai');
            addOutput('  "create a driving techno beat"', 'ai');
            addOutput('  "add atmospheric pads with reverb"', 'ai');
            addOutput('  "make a groovy bass line"', 'ai');
            addOutput('', 'info');
            addOutput('‚ö° DIRECT COMMANDS:', 'success');
            addOutput('  play drums "x-o-x-o-" (x=kick, o=snare, -=rest)', 'success');
            addOutput('  play bass [0,0,3,7] with drive', 'success');
            addOutput('  play melody [0,2,4,5] with reverb', 'success');
            addOutput('  add pads [0,4,7,11] slowly', 'success');
            addOutput('', 'info');
            addOutput('üéõÔ∏è EFFECTS:', 'warning');
            addOutput('  with reverb, with delay, with drive, with filter', 'warning');
            addOutput('  slowly, fast, groovy, minimal', 'warning');
            addOutput('', 'info');
            addOutput('üéöÔ∏è CONTROLS:', 'info');
            addOutput('  stop all, pause all, play all, clear', 'info');
            addOutput('  state - show current players', 'info');
        }

        function shareProject() {
            const projectData = {
                musicState: musicState,
                tempo: currentTempo,
                timestamp: Date.now()
            };
            
            const encoded = btoa(JSON.stringify(projectData));
            const shareUrl = `${window.location.origin}${window.location.pathname}?project=${encoded}`;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                addOutput('üîó Project link copied to clipboard!', 'success');
            }).catch(() => {
                addOutput(`üîó Share URL: ${shareUrl}`, 'info');
            });
        }

        function showSettings() {
            addOutput('‚öôÔ∏è Settings panel would open here', 'info');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function exportAudio() {
            addOutput('üíæ Audio export feature would trigger here', 'info');
        }

        // Event listeners
        document.getElementById('commandInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processCommand();
            }
        });

        // Load project from URL
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const projectData = urlParams.get('project');
            
            if (projectData) {
                try {
                    const decoded = JSON.parse(atob(projectData));
                    musicState = decoded.musicState || {};
                    currentTempo = decoded.tempo || 120;
                    
                    addOutput('üîó Project loaded from shared link!', 'success');
                    updatePlayersDisplay();
                } catch (error) {
                    addOutput('‚ùå Invalid project link', 'error');
                }
            }
            
            // Start time tracking
            setInterval(updateTimeDisplay, 1000);
            
            // Welcome message
            setTimeout(() => {
                addOutput('üöÄ Enhanced studio ready! Try a preset or describe your musical vision.', 'success');
            }, 1000);
        });
    </script>
</body>
</html>